import datetime
import json
from typing import Dict
import requests
from base import BaseFinder, FinderABC
from utils import get_date_from_string



class CianFinder(BaseFinder):
    
    url = 'https://api.cian.ru/search-offers/v3/search-offers-desktop/'
    offer_url = 'https://spb.cian.ru/rent/flat/{id}/'
    filter = {
        "jsonQuery": {
            "_type": "flatrent",
            "sort": {
            "type": "term",
            "value": "creation_date_desc"
            },
            "engine_version": {
            "type": "term",
            "value": 2
            },
            "price": {
            "type": "range",
            "value": {
                "gte": 25000,
                "lte": 40000
            }
            },
            "currency": {
            "type": "term",
            "value": 2
            },
            "geo": {
            "type": "geo",
            "value": [
                {
                "type": "polygon",
                "name": "Область поиска",
                "coordinates": [
                    [
                    "30.2277481",
                    "60.012513"
                    ],
                    [
                    "30.2112686",
                    "60.0100996"
                    ],
                    [
                    "30.1975357",
                    "60.004928"
                    ],
                    [
                    "30.1920425",
                    "59.9956191"
                    ],
                    [
                    "30.1920425",
                    "59.9863102"
                    ],
                    [
                    "30.1927292",
                    "59.9776909"
                    ],
                    [
                    "30.1941024",
                    "59.9673477"
                    ],
                    [
                    "30.1941024",
                    "59.9587283"
                    ],
                    [
                    "30.1941024",
                    "59.9497642"
                    ],
                    [
                    "30.1961624",
                    "59.9414897"
                    ],
                    [
                    "30.1947891",
                    "59.9332151"
                    ],
                    [
                    "30.2016556",
                    "59.9252853"
                    ],
                    [
                    "30.2160751",
                    "59.9204585"
                    ],
                    [
                    "30.2339279",
                    "59.9183898"
                    ],
                    [
                    "30.251094",
                    "59.9177003"
                    ],
                    [
                    "30.2620804",
                    "59.9108048"
                    ],
                    [
                    "30.2751266",
                    "59.9052885"
                    ],
                    [
                    "30.2867996",
                    "59.8994273"
                    ],
                    [
                    "30.2929794",
                    "59.8911527"
                    ],
                    [
                    "30.2950393",
                    "59.8811543"
                    ],
                    [
                    "30.2916061",
                    "59.8721902"
                    ],
                    [
                    "30.2922928",
                    "59.8639156"
                    ],
                    [
                    "30.293666",
                    "59.8552963"
                    ],
                    [
                    "30.2950393",
                    "59.8463322"
                    ],
                    [
                    "30.293666",
                    "59.8373681"
                    ],
                    [
                    "30.3032791",
                    "59.8294383"
                    ],
                    [
                    "30.317012",
                    "59.8225428"
                    ],
                    [
                    "30.3341781",
                    "59.8194399"
                    ],
                    [
                    "30.3540909",
                    "59.8194399"
                    ],
                    [
                    "30.3719436",
                    "59.820819"
                    ],
                    [
                    "30.3884231",
                    "59.8218533"
                    ],
                    [
                    "30.4035293",
                    "59.825301"
                    ],
                    [
                    "30.4172622",
                    "59.8304726"
                    ],
                    [
                    "30.425502",
                    "59.8377129"
                    ],
                    [
                    "30.4364883",
                    "59.8442635"
                    ],
                    [
                    "30.4529678",
                    "59.8473665"
                    ],
                    [
                    "30.4701339",
                    "59.8463322"
                    ],
                    [
                    "30.4866134",
                    "59.8432292"
                    ],
                    [
                    "30.5024063",
                    "59.8394367"
                    ],
                    [
                    "30.5181991",
                    "59.8370233"
                    ],
                    [
                    "30.5133926",
                    "59.8456426"
                    ],
                    [
                    "30.5078994",
                    "59.8539172"
                    ],
                    [
                    "30.501033",
                    "59.8621918"
                    ],
                    [
                    "30.4900467",
                    "59.8687425"
                    ],
                    [
                    "30.49142",
                    "59.8780513"
                    ],
                    [
                    "30.4996597",
                    "59.8856364"
                    ],
                    [
                    "30.5051529",
                    "59.8939109"
                    ],
                    [
                    "30.4989731",
                    "59.9025303"
                    ],
                    [
                    "30.4907333",
                    "59.9108048"
                    ],
                    [
                    "30.4852401",
                    "59.9190794"
                    ],
                    [
                    "30.4790603",
                    "59.9276987"
                    ],
                    [
                    "30.4728805",
                    "59.9363181"
                    ],
                    [
                    "30.4625808",
                    "59.9428688"
                    ],
                    [
                    "30.4529678",
                    "59.9507986"
                    ],
                    [
                    "30.4502212",
                    "59.9590731"
                    ],
                    [
                    "30.4515945",
                    "59.9680372"
                    ],
                    [
                    "30.4522812",
                    "59.9766566"
                    ],
                    [
                    "30.4536545",
                    "59.9849311"
                    ],
                    [
                    "30.4529678",
                    "59.9938952"
                    ],
                    [
                    "30.446788",
                    "60.0025146"
                    ],
                    [
                    "30.4364883",
                    "60.0097548"
                    ],
                    [
                    "30.4220688",
                    "60.0142369"
                    ],
                    [
                    "30.4062759",
                    "60.0190637"
                    ],
                    [
                    "30.3891098",
                    "60.0194085"
                    ],
                    [
                    "30.3746902",
                    "60.0238905"
                    ],
                    [
                    "30.3588974",
                    "60.0266487"
                    ],
                    [
                    "30.3410446",
                    "60.027683"
                    ],
                    [
                    "30.3245651",
                    "60.0273383"
                    ],
                    [
                    "30.3060257",
                    "60.0256144"
                    ],
                    [
                    "30.2881729",
                    "60.0252696"
                    ],
                    [
                    "30.2710067",
                    "60.0245801"
                    ],
                    [
                    "30.2545273",
                    "60.023201"
                    ],
                    [
                    "30.2366745",
                    "60.0211323"
                    ],
                    [
                    "30.2208816",
                    "60.0166503"
                    ],
                    [
                    "30.2092087",
                    "60.0107891"
                    ],
                    [
                    "30.2277481",
                    "60.012513"
                    ]
                ]
                }
            ]
            },
            "bbox": {
            "type": "term",
            "value": [
                [
                29.8073907714,
                59.6551418686
                ],
                [
                30.9609552246,
                59.9144021277
                ]
            ]
            },
            "floorn": {
            "type": "range",
            "value": {
                "gte": 2
            }
            },
            "saved_search_id": {
            "type": "term",
            "value": 51596133
            },
            "for_day": {
            "type": "term",
            "value": "!1"
            },
            "repair": {
            "type": "terms",
            "value": [
                3,
                4
            ]
            },
            "room": {
            "type": "terms",
            "value": [
                1,
                9
            ]
            }
        }
        }

    def get_offers(self):
        print(f'Request Cian')
        response = requests.post(
            self.url,
            json=self.filter,
        )
        
        try:
            return response.json().get('offers', [])
        except:
            print(response.text)
            return []
    
    def get_offer_datetime(self, offer: Dict):
        datetime = get_date_from_string(offer['data']['updatedOn'])
        time_split = offer['data']['updatedAt'].split(',')[1].split(':')

        datetime = datetime.replace(
            hour = int(time_split[0]),
            minute = int(time_split[1])
        )
        return datetime
    
    def get_notification_message(self, offer: Dict):
        message = 'Появилось новое объявление на ЦИАН: {url}'
        offer_id = offer['id']  
        offer_url = self.offer_url.format(id=offer_id)

        return message.format(url=offer_url)
    
